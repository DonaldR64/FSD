const CloseCombat = (msg) => {
    let Tag = msg.content.split(";");
    let attackerID = Tag[1];
    let defenderID = Tag[2];
    let attacker = UnitArray[attackerID];
    let defender = UnitArray[defenderID];
    let defenderStatus = "Passive";
    let defenderText = "Defender is a PASSIVE Defender";
    SetupCard("Close Combat","",attacker.faction);

    if (defender.token.get(SM.deactived) === true) {
        outputCard.body.push("Defender was Deactivated and so Destroyed");
        defenderStatus = "Destroyed";
    }
    if (defender.token.get(SM.immobilized) === true && (defender.type === "Vehicle" || defender.type === "Aircraft")) {
        outputCard.body.push("Defender " + defender.type + " was Immobilized and so Destroyed");
        defenderStatus = "Destroyed";
    }


    if (defenderStatus === "Destroyed") {
        PrintCard();
        defender.Destroyed();
        return;
    }


    //aircraft charging







    if (defender.token.get("aura1_color") === "#800080") {
        //is on guard
        defenderStatus = "Active";
        defenderText = "Defender is on Guard and is an ACTIVE Defender"
        if (defender.hexLabel !== defender.startHexLabel) {
            //defender countercharged
            defenderStatus = "Attacker";
            defenderText = "Defender Countercharges and is treated as an Attacker as well";
        }
        defender.token.set("aura1_color") === "#000000";
    } else {
        let defActions = parseInt(defender.token.get("bar1_value"));
        if (defActions > 0) {
            defenderText = "Defender Spends an Action to be ACTIVE Defender";
            defender.token.set("bar1_value",defActions - 1);
            defenderStatus = "Active";
        }
    }
    outputCard.body.push(defenderText);
    outputCard.body.push("[hr]");

    combatArray = {
        attacker: attacker,
        defender: defender,
        defenderStatus: defenderStatus,
        results: {},
    }

    //calculate CR. Returns CR and tips - tips pulled out in output
    combatArray.attCRResults = CR(attacker,defender,"Attacker");
    combatArray.defCRResults = CR(defender,attacker,defenderStatus);
    AttackRolls();
    CCOutput();

    //move below into CCOutput
    attacker.Damage();
    if (attacker.token.get(SM.immobilized) === true && attacker.type !== "Walker") {
        outputCard.body.push(attacker.name + " is Immobilized and Destroyed");
        attacker.Detroyed();
    }
    if (attacker.token.get(SM.disabled) === true && attacker.type !== "Infantry") {
        outputCard.body.push(attacker.name + " is Disabled and Destroyed");
        attacker.Detroyed();
    }
    defender.Damage();
    if (defender.token.get(SM.immobilized) === true && defender.type !== "Walker") {
        outputCard.body.push(defender.name + " is Immobilized and Destroyed");
        defender.Detroyed();
    }
    if (defender.token.get(SM.disabled) === true && defender.type !== "Infantry") {
        outputCard.body.push(defender.name + " is Disabled and Destroyed");
        defender.Detroyed();
    }

    PrintCard();


}


const CCOutput = () => {
    log(combatArray)


}
